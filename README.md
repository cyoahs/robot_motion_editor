# 机器人关键帧编辑器

一个基于 Web 的机器人关键帧编辑工具，支持 URDF 文件加载、轨迹编辑和 3D 可视化。

## 功能特性

- **URDF 加载**: 支持加载整个文件夹，自动解析 URDF 文件中的相对路径引用的 mesh 文件
- **CSV 轨迹加载**: 加载轨迹数据（前 7 列为 base 的 xyz + 四元数 xyzw，后面为关节位置）
- **3D 可视化**: 使用 Three.js 实时渲染机器人模型
- **时间轴控制**: 底部时间轴可拖动查看任意时刻的机器人状态
- **关节控制**: 右侧面板显示每个关节的角度，支持滑块和数字编辑
- **关键帧编辑**: 基于残差的关键帧系统，CSV 为基础轨迹，编辑的关键帧为残差
- **轨迹导出**: 导出叠加后的完整轨迹（base + residual）

## 技术栈

- **Vite**: 现代化的前端构建工具
- **Three.js**: 3D 图形渲染库
- **urdf-loader**: URDF 文件解析库
- **原生 JavaScript**: 无框架依赖，轻量高效

## 安装与运行

```bash
# 安装依赖
npm install

# 启动开发服务器
npm run dev

# 构建生产版本
npm run build

# 预览生产构建
npm run preview
```

## 使用说明

### 1. 加载 URDF 文件夹

点击 "加载 URDF 文件夹" 按钮，选择包含 URDF 文件及其引用的 mesh 文件的完整文件夹。工具会自动：
- 查找 `.urdf` 文件
- 解析相对路径引用
- 加载所有 mesh 文件
- 在 3D 视图中渲染机器人模型

### 2. 加载 CSV 轨迹

点击 "加载 CSV 轨迹" 按钮，选择轨迹 CSV 文件。文件格式要求：
- 每行代表一帧
- 前 7 列: `x, y, z, qx, qy, qz, qw` (base 位置和四元数)
- 后续列: 关节位置（弧度制）

示例：
```csv
0.0, 0.0, 0.5, 0.0, 0.0, 0.0, 1.0, 0.0, 0.5, -1.0, 1.5, ...
0.0, 0.0, 0.5, 0.0, 0.0, 0.0, 1.0, 0.1, 0.6, -1.1, 1.6, ...
```

### 3. 时间轴控制

- 底部滑块可拖动到任意时刻
- 显示当前时间和总时长
- 机器人会实时更新到对应时刻的状态

### 4. 关节编辑

- 右侧面板显示所有可动关节
- 每个关节有滑块和数字输入框
- 修改关节值会实时更新机器人姿态

### 5. 添加关键帧

1. 在时间轴上选择要添加关键帧的时刻
2. 在右侧调整关节到期望的姿态
3. 点击 "添加关键帧" 按钮
4. 系统会计算当前值与 base 值的残差并保存
5. 关键帧会在时间轴上以绿色标记显示

### 6. 删除关键帧

方法一：点击删除按钮
- 将时间轴移动到要删除的关键帧位置
- 点击 "删除当前关键帧" 按钮

方法二：右键点击标记
- 在时间轴上右键点击关键帧标记
- 在弹出的确认对话框中选择确定

### 7. 导出轨迹

点击 "导出轨迹" 按钮，系统会：
- 对所有关键帧进行插值
- 将残差叠加到 base 轨迹上
- 导出为 CSV 文件（格式与输入相同）

## 关键帧残差系统

编辑逻辑说明：
- **Base 轨迹**: CSV 加载的原始轨迹，不可修改
- **关键帧**: 用户编辑的特定时刻的关节姿态
- **残差**: 关键帧相对于 base 的偏移量 (`residual = edited - base`)
- **插值**: 两个关键帧之间的残差进行线性插值
- **最终输出**: `final = base + interpolated_residual`

这种设计的优势：
- 保留原始轨迹数据
- 仅存储修改的部分，节省空间
- 可以随时重置到 base 轨迹
- 支持平滑的过渡动画

## 项目结构

```
robot-keyframe-editor/
├── index.html              # 主 HTML 文件
├── package.json            # 项目配置
├── vite.config.js          # Vite 配置
├── src/
│   ├── main.js             # 主应用入口
│   ├── urdfLoader.js       # URDF 文件加载器
│   ├── trajectoryManager.js # 轨迹管理器（base + residual）
│   ├── jointController.js  # 关节控制器
│   └── timelineController.js # 时间轴控制器
└── .github/
    └── copilot-instructions.md # AI 辅助开发说明
```

## 开发说明

### 核心模块

- **main.js**: 应用主类，负责场景初始化和模块协调
- **urdfLoader.js**: 处理 URDF 文件夹加载和 mesh 解析
- **trajectoryManager.js**: 管理 base 轨迹、关键帧和残差插值
- **jointController.js**: 关节 UI 控制和值更新
- **timelineController.js**: 时间轴交互和帧同步

### 扩展功能建议

- [ ] 支持多种插值方式（线性、样条、贝塞尔）
- [ ] 添加关键帧可视化标记
- [ ] 支持撤销/重做操作
- [ ] 播放/暂停动画
- [ ] IK（逆运动学）支持
- [ ] 碰撞检测

## License

MIT
